<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rally "O Alvo" - Pontua√ß√£o e Administra√ß√£o</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Cores Inspiradas em Juventude Crist√£ - Mais Profissional e Vibrante */
            --primary-dark-blue: #002D62; /* Azul Marinho Profundo, para cabe√ßalhos fortes, fundo */
            --primary-blue: #0A6BEF; /* Azul Principal, vibrante e moderno */
            --secondary-light-blue: #64B5F6; /* Azul Claro, para detalhes e acentos suaves */
            --accent-green: #4CAF50; /* Verde vibrante para sucesso/a√ß√µes */
            --accent-yellow: #FFD700; /* Dourado para destaque/rank ouro */
            --light-gray-bg: #F8F9FA; /* Fundo muito claro, quase branco */
            --medium-gray-border: #E0E0E0; /* Cinza para bordas sutis */
            --dark-text: #212529; /* Texto escuro padr√£o */
            --light-text: #495057; /* Texto cinza para paragrafos */
            --danger-red: #DC3545; /* Vermelho para alerta/bot√µes perigosos */

            /* Mapeamento para nomes de vari√°veis existentes */
            --header-bg: var(--primary-dark-blue);
            --main-color: var(--primary-blue);
            --success-color: var(--accent-green);
            --rank-gold: var(--accent-yellow);
            --rank-silver: #B0BEC5; /* Prata, mais suave */
            --rank-bronze: #E67E22; /* Bronze, mais amig√°vel */
            --button-hover-color: #085CD2; /* Tom mais escuro do azul principal para hover */
            --info-color: #17A2B8;
            --white: #FFFFFF; /* Garante o branco puro */
        }

        body {
            font-family: 'Inter', sans-serif; /* Fonte para o corpo do texto */
            margin: 0;
            padding: 0;
            background-color: var(--light-gray-bg);
            color: var(--dark-text);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
            justify-content: flex-start; /* Alinha ao topo para considerar o header fixo */
            padding-top: 80px; /* Espa√ßo para o cabe√ßalho fixo */
            overflow-x: hidden; /* Evita rolagem horizontal indesejada */
        }

        header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: var(--header-bg);
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 999;
            box-sizing: border-box; /* Inclui padding e borda na largura total */
        }

        header h1 {
            margin: 0;
            font-family: 'Montserrat', sans-serif; /* Fonte para o t√≠tulo do header */
            font-size: 2em; /* Tamanho maior no header */
            color: var(--white);
            font-weight: 800;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            padding-bottom: 0;
            border-bottom: none;
        }

        .login-btn-header {
            background-color: var(--primary-blue);
            color: var(--white);
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 25px; /* Bot√µes mais arredondados */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .login-btn-header:hover {
            background-color: var(--button-hover-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .container {
            max-width: 1000px; /* Aumenta um pouco a largura m√°xima do container principal */
            width: 95%; /* Usa 95% da largura em telas grandes */
            margin: 30px auto; /* Mais margem superior e inferior */
            background-color: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            transition: all 0.3s ease-in-out;
            position: relative;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        h1 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-dark-blue);
            text-align: center;
            margin-bottom: 35px;
            font-weight: 800;
            font-size: 3.2em;
            border-bottom: 5px solid var(--medium-gray-border);
            padding-bottom: 25px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-blue);
            text-align: center;
            margin-top: 45px;
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 2.5em;
        }

        .mission, .tribe-scoring-section {
            background-color: var(--white);
            border: 1px solid var(--medium-gray-border);
            border-radius: 12px;
            padding: 35px;
            margin-bottom: 35px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .mission h2 {
            background-color: var(--primary-dark-blue);
            color: var(--white);
            padding: 18px 30px;
            margin: -35px -35px 30px -35px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            font-size: 2em;
            text-align: left;
            font-weight: 700;
        }

        label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--dark-text);
            font-size: 1.1em;
        }

        input[type="number"],
        input[type="checkbox"],
        select {
            padding: 16px;
            border: 1px solid var(--medium-gray-border);
            border-radius: 10px;
            font-size: 1.2em;
            width: 100%;
            max-width: 300px;
            text-align: center;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="number"]:focus,
        select:focus,
        .modal-content input[type="text"]:focus,
        .modal-content input[type="password"]:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 0.3rem rgba(10, 107, 239, 0.3);
            outline: none;
        }

        input[type="checkbox"] {
            width: auto;
            transform: scale(1.5);
            margin-right: 12px;
            vertical-align: middle;
            accent-color: var(--accent-green);
        }

        p {
            margin-top: 18px;
            color: var(--light-text);
            font-size: 1.1em;
        }

        .button-group {
            display: flex;
            gap: 25px;
            margin-top: 35px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .admin-nav-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 3px solid var(--medium-gray-border);
            padding-bottom: 15px;
        }

        .admin-nav-tabs button {
            background-color: var(--light-gray-bg);
            color: var(--primary-dark-blue);
            border: 2px solid var(--primary-blue);
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
        }

        .admin-nav-tabs button:hover {
            background-color: var(--primary-blue);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .admin-nav-tabs button.active {
            background-color: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .button-group button {
            padding: 18px 40px;
            font-size: 1.3em;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
        }

        .button-group button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .button-group .info-btn {
            background-color: var(--white);
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }
        .button-group .info-btn:hover {
            background-color: var(--primary-blue);
            color: var(--white);
        }

        .button-group .primary-btn {
            background-color: var(--primary-blue);
            color: var(--white);
        }

        .button-group .primary-btn:hover {
            background-color: var(--button-hover-color);
        }

        .button-group .danger-btn {
            background-color: var(--danger-red);
            color: var(--white);
        }

        .button-group .danger-btn:hover {
            background-color: #C82333;
        }

        .button-group .secondary-btn {
            background-color: var(--accent-green);
            color: var(--white);
        }
        .button-group .secondary-btn:hover {
            background-color: #2E8B57;
        }

        .hidden {
            display: none !important;
        }

        .total-section {
            display: flex;
            flex-wrap: wrap;
            gap: 35px;
            margin-top: 45px;
            justify-content: center;
        }

        .total, .tribe-total, .ranking, #leaderDisplay {
            flex: 1;
            min-width: 280px;
            background-color: var(--primary-blue);
            color: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.4);
            text-align: center;
        }

        .tribe-total {
            background-color: var(--secondary-light-blue);
        }

        .total h2, .tribe-total h2, .ranking h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--white);
            margin: 0;
            font-size: 2.5em;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        .tribe-icon {
            width: 50px;
            height: 50px;
            vertical-align: middle;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--white);
        }

        #dailyBaseDisplay, .tribe-score {
            font-size: 4em;
            font-weight: 900;
            display: block;
            margin-top: 25px;
            color: var(--white);
            text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
        }

        #leaderDisplay {
            background-color: var(--primary-dark-blue);
            color: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            text-align: center;
        }
        #leaderDisplay h2 {
            color: var(--white);
            font-size: 2.5em;
            margin-bottom: 0;
            display: block;
            align-items: unset;
            justify-content: unset;
            gap: unset;
        }

        #leaderName {
            font-family: 'Montserrat', sans-serif;
            font-size: 4.5em;
            font-weight: 900;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            color: var(--accent-yellow);
            text-shadow: 4px 4px 10px rgba(0, 0, 0, 0.8);
            animation: bounceIn 1s ease-out;
            width: 100%;
        }
        #leaderName .leader-icon {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--accent-yellow);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }
        #leaderName .leader-text {
            display: block;
            color: var(--accent-yellow);
        }

        .ranking {
            background-color: var(--primary-dark-blue);
            text-align: left;
            padding: 40px;
        }

        .ranking h2 {
            text-align: center;
            margin-bottom: 30px;
        }

        .ranking ol {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ranking li {
            font-size: 1.4em;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            color: var(--white);
            font-weight: 500;
        }

        .ranking li:last-child {
            border-bottom: none;
        }

        .ranking li .trophy {
            font-size: 2.2em;
            line-height: 1;
            margin-right: 10px;
        }
        .ranking li .tribe-rank-name-group {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            flex-grow: 1;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.4);
        }
        .ranking li .tribe-rank-name-group .tribe-icon {
            width: 35px;
            height: 35px;
            border: 1px solid var(--white);
        }

        .ranking li .tribe-rank-score {
            font-weight: 800;
            font-size: 1.7em;
            color: var(--white);
            text-shadow: 1px 1px 4px rgba(0,0,0,0.4);
        }

        /* Cores dos ranks */
        .ranking li:nth-child(1) .tribe-rank-name-group .tribe-name-text { color: var(--rank-gold); }
        .ranking li:nth-child(2) .tribe-rank-name-group .tribe-name-text { color: var(--rank-silver); }
        .ranking li:nth-child(3) .tribe-rank-name-group .tribe-name-text { color: var(--rank-bronze); }

        #regulation-section, #history-section, #admin-overview-section, #daily-missions-section-admin, #tribe-scoring-section, #week-selection-admin {
            background-color: var(--white);
            border: 1px solid var(--medium-gray-border);
            border-radius: 12px;
            padding: 35px;
            margin-bottom: 35px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
            color: var(--dark-text);
        }
        #admin-overview-section, #daily-missions-section-admin, #tribe-scoring-section {
            margin-top: 20px;
        }

        #regulation-section h2, #history-section h2, #admin-overview-section h2 {
            color: var(--primary-dark-blue);
            text-align: center;
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2.8em;
        }

        #regulation-section h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-blue);
            margin-top: 35px;
            margin-bottom: 18px;
            font-size: 2.2em;
            font-weight: 700;
        }

        #regulation-section h4 {
            font-family: 'Montserrat', sans-serif;
            color: var(--accent-green);
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.8em;
            font-weight: 600;
        }

        #regulation-section ul {
            list-style: disc;
            margin-left: 35px;
            margin-bottom: 18px;
            font-size: 1.1em;
            color: var(--light-text);
        }

        #regulation-section li {
            margin-bottom: 10px;
        }

        #regulation-section p {
            margin-bottom: 18px;
            color: var(--light-text);
            font-size: 1.1em;
        }
        #regulation-section hr {
            border: 0;
            height: 2px;
            background: var(--medium-gray-border);
            margin: 35px 0;
        }

        #championAnimation {
            display: none; /* Alterado para none por padr√£o */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 45, 98, 0.98);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            overflow: hidden;
            animation: fadeIn 0.8s ease-out forwards;
            backdrop-filter: blur(8px);
        }

        .confetti {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            opacity: 0;
            animation: confettiFall 5s infinite ease-out;
        }

        #championTitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 6em;
            color: var(--accent-yellow);
            font-weight: 900;
            margin-bottom: 40px;
            text-shadow: 8px 8px 20px rgba(0, 0, 0, 0.95);
            animation: pulse 1.5s infinite alternate, glow 1s infinite alternate;
        }

        #championNameAnimated {
            font-family: 'Montserrat', sans-serif;
            font-size: 8em;
            color: var(--white);
            font-weight: 900;
            text-shadow: 10px 10px 25px rgba(0, 0, 0, 0.98);
            animation: slideIn 1.5s ease-out forwards, colorChange 3s infinite alternate;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 25px;
        }
        #championNameAnimated .tribe-icon {
            width: 150px;
            height: 150px;
            border-width: 6px;
        }

        /* --- Estilos para o Modal de Login --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
            max-width: 450px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .close-button {
            color: var(--light-text);
            font-size: 32px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 25px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--danger-red);
            text-decoration: none;
        }

        .modal-content h1 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-dark-blue);
            font-size: 2.8em;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 4px solid var(--medium-gray-border);
            letter-spacing: 1.2px;
        }
        .modal-content p {
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 1.15em;
        }
        .modal-content label {
            margin-bottom: 10px;
            font-size: 1.05em;
        }
        .modal-content input {
            padding: 15px;
            font-size: 1.15em;
            margin-bottom: 20px;
            max-width: 300px;
        }
        .modal-content .button-group {
            margin-top: 25px;
            max-width: 300px;
        }
        #login-message {
            margin-top: 25px;
            font-size: 1.1em;
        }

        /* Tabela Hist√≥rico */
        #history-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            font-size: 1.05em;
            text-align: center;
        }

        #history-section th, #history-section td {
            border: 1px solid var(--medium-gray-border);
            padding: 12px 8px;
        }

        #history-section thead th {
            background-color: var(--primary-dark-blue);
            color: var(--white);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #history-section tbody tr:nth-child(even) {
            background-color: var(--light-gray-bg);
        }
        #history-section tbody tr:hover {
            background-color: var(--secondary-light-blue);
            color: var(--white);
        }

        #history-section tfoot td {
            background-color: var(--primary-blue);
            color: var(--white);
            font-weight: 700;
            padding: 15px 8px;
            border-top: 2px solid var(--primary-dark-blue);
        }


        /* Media Queries - Adapta√ß√£o para Telas Menores */
        @media (max-width: 992px) {
            body { padding-top: 70px; }
            header { padding: 12px 20px; }
            header h1 { font-size: 1.6em; }
            .login-btn-header { padding: 8px 15px; font-size: 0.9em; }
            .container { padding: 30px; margin: 20px auto; }
            h1 { font-size: 2.8em; }
            h2 { font-size: 2.2em; }
            .mission h2 { font-size: 1.8em; margin: -30px -30px 25px -30px; }
            input[type="number"], select { padding: 14px; font-size: 1.1em; }
            .button-group button { padding: 16px 35px; font-size: 1.2em; }
            #dailyBaseDisplay, .tribe-score { font-size: 3.5em; }
            #leaderName { font-size: 4em; }
            #leaderName .leader-icon { width: 100px; height: 100px; }
            .ranking li { font-size: 1.3em; }
            .ranking li .trophy { font-size: 2em; }
            .ranking li .tribe-rank-score { font-size: 1.5em; }
            #championTitle { font-size: 5em; }
            #championNameAnimated { font-size: 7em; }
            #championNameAnimated .tribe-icon { width: 120px; height: 120px; }
            #regulation-section h2 { font-size: 2.2em; }
            #regulation-section h3 { font-size: 1.8em; }
            #regulation-section h4 { font-size: 1.5em; }
            .modal-content { padding: 35px; max-width: 400px; }
            .modal-content h1 { font-size: 2.2em; }
            .modal-content input { padding: 12px; font-size: 1em; }
        }

        @media (max-width: 768px) {
            body { padding: 10px; padding-top: 60px; }
            header { flex-direction: row; padding: 10px 15px; }
            header h1 { font-size: 1.3em; }
            .login-btn-header { padding: 6px 12px; font-size: 0.8em; }
            .container { padding: 25px; margin: 15px auto; width: 98%; }
            .total-section { flex-direction: column; gap: 25px; }
            .total, .tribe-total, .ranking, #leaderDisplay { padding: 30px; min-width: unset; }
            .button-group { flex-direction: column; gap: 15px; }
            input[type="number"], select { max-width: 100%; padding: 12px; font-size: 1em; }
            h1 { font-size: 2em; padding-bottom: 15px; margin-bottom: 25px; }
            h2 { font-size: 1.8em; margin-top: 30px; margin-bottom: 20px; }
            .mission h2 { font-size: 1.5em; padding: 15px 20px; margin: -25px -25px 20px -25px; }
            label { font-size: 0.95em; }
            p { font-size: 0.9em; }
            .button-group button { padding: 14px 28px; font-size: 1.1em; }
            #dailyBaseDisplay, .tribe-score { font-size: 3em; }
            #leaderName { font-size: 3.5em; gap: 10px; }
            #leaderName .leader-icon { width: 80px; height: 80px; border-width: 3px; }
            .ranking li { font-size: 1.1em; padding: 10px 0; gap: 10px; }
            .ranking li .trophy { font-size: 1.8em; }
            .ranking li .tribe-rank-score { font-size: 1.3em; }
            .ranking li .tribe-rank-name-group .tribe-icon { width: 28px; height: 28px; }
            #championTitle { font-size: 3.8em; }
            #championNameAnimated { font-size: 5.5em; gap: 15px; }
            #championNameAnimated .tribe-icon { width: 100px; height: 100px; border-width: 4px; }
            #regulation-section { padding: 20px; }
            #regulation-section h2 { font-size: 2em; }
            #regulation-section h3 { font-size: 1.6em; }
            #regulation-section h4 { font-size: 1.2em; }
            #history-section table { display: block; overflow-x: auto; white-space: nowrap; }
            #history-section thead, #history-section tbody, #history-section tfoot,
            #history-section th, #history-section td, #history-section tr { display: table-cell; white-space: nowrap; }
            #history-section tr { display: table-row; }
            .modal-content { padding: 25px; }
            .modal-content h1 { font-size: 2em; }
            .modal-content p { font-size: 1em; }
            .modal-content input { padding: 10px; font-size: 0.95em; }
        }
    </style>
</head>
<body>
<header>
    <h1>Rally "O Alvo"</h1>
    <button class="login-btn-header" onclick="openLoginModal()">Login Secretaria</button>
</header>

<div id="login-modal" class="modal hidden">
    <div class="modal-content">
        <span class="close-button" onclick="closeLoginModal()">&times;</span>
        <h1>Login Secretaria Rally "O Alvo"</h1>
        <p>Acesse com seu usu√°rio e senha para gerenciar as pontua√ß√µes.</p>
        <label for="login-username">Usu√°rio:</label>
        <input type="text" id="login-username" placeholder="Usu√°rio da secretaria">

        <label for="login-password">Senha:</label>
        <input type="password" id="login-password" placeholder="Senha">

        <div class="button-group">
            <button class="primary-btn" onclick="performLogin()">Entrar</button>
        </div>
        <p id="login-message" style="color: red; margin-top: 15px; font-weight: 600;"></p>
    </div>
</div>

<div class="container">
    <div id="public-content">
        <h1>Resultados do Rally "O Alvo"</h1>
        <p style="text-align: center; margin-bottom: 40px;">Acompanhe a pontua√ß√£o das tribos e a classifica√ß√£o geral do nosso Rally "O Alvo"! Fique ligado para ver qual tribo alcan√ßar√° o Alvo.</p>
        <hr>
        <div class="total-section">
            <div class="tribe-total">
                <h2><img src="Levi.png" alt="Logo Levi" class="tribe-icon"> Tribo de Levi</h2>
                <span class="tribe-score" id="score_levi">0</span>
            </div>

            <div class="tribe-total">
                <h2><img src="Juda.png" alt="Logo Jud√°" class="tribe-icon"> Tribo de Jud√°</h2>
                <span class="tribe-score" id="score_juda">0</span>
            </div>

            <div class="tribe-total">
                <h2><img src="Naftali.png" alt="Logo Naftali" class="tribe-icon"> Tribo de Naftali</h2>
                <span class="tribe-score" id="score_naftali">0</span>
            </div>

            <div class="tribe-total">
                <h2><img src="Gade.png" alt="Logo Gade" class="tribe-icon"> Tribo de Gade</h2>
                <span class="tribe-score" id="score_gade">0</span>
            </div>

            <div class="ranking">
                <h2>Classifica√ß√£o das Tribos (Total)</h2>
                <ol id="tribes_ranking"></ol>
            </div>

            <div id="leaderDisplay">
                <h2>L√≠der Atual:</h2>
                <span id="leaderName"><span class="leader-text">Nenhuma tribo pontuada</span></span>
            </div>
        </div>
    </div>

    <div id="admin-content" class="hidden">
        <h1>Rally "O Alvo" - Painel da Secretaria</h1>
        <p style="text-align: center; margin-bottom: 20px;">Semana Atual: <strong id="current-week-display">1</strong> / <span id="total-weeks-display">9</span></p>

        <div class="admin-nav-tabs">
            <button id="tab-daily-missions-section-admin" class="active" onclick="toggleSection('daily-missions-section-admin')">Pontua√ß√£o Di√°ria</button>
            <button id="tab-admin-overview-section" onclick="toggleSection('admin-overview-section')">Vis√£o Geral do Rally</button>
            <button id="tab-regulation-section" onclick="toggleSection('regulation-section')">Ver Regulamento</button>
            <button id="tab-history-section" onclick="toggleSection('history-section')">Hist√≥rico Semanal</button>
            <button id="tab-championAnimation" onclick="toggleSection('championAnimation')">Ver Campe√£o Final</button>
            <button class="danger-btn" style="padding: 12px 25px; font-size: 1.1em;" onclick="confirmEndWeek()">Finalizar Semana</button>
            <button class="info-btn" style="padding: 12px 25px; font-size: 1.1em;" onclick="performLogout()">Sair (Logout)</button>
        </div>
        
        <div id="week-selection-admin" class="mission">
            <h2>Gerenciar Semana</h2>
            <label for="week-selector">Mudar para Semana:</label>
            <select id="week-selector" onchange="confirmChangeWeek()"></select>
            <p style="margin-top: 15px; font-size: 0.9em; color: var(--light-text);">Selecione uma semana anterior para rever ou editar pontua√ß√µes j√° salvas, ou uma semana futura para adiantar o rally. A semana atual √© <strong id="current-week-number-display-selection">1</strong>.</p>
        </div>


        <div id="daily-missions-section-admin">
            <h2>Pontua√ß√£o Di√°ria das Miss√µes</h2>
            <p>Preencha os campos abaixo para calcular a pontua√ß√£o base di√°ria da semana atual (Semana <strong id="daily-mission-current-week">1</strong>).</p>
            <div class="mission">
                <h2>Segunda-feira - Algo a Mais</h2>
                <label for="segunda">Jovens presentes:</label>
                <input type="number" id="segunda" value="0" oninput="calculateDailyBase('segunda')" min="0">
                <p>Pontos: 50 cada</p>
            </div>

            <div class="mission">
                <h2>Ter√ßa-feira - P√© no Bairro</h2>
                <label for="terca">Trabalhos realizados (m√≠nimo 3 jovens):</label>
                <input type="number" id="terca" value="0" oninput="calculateDailyBase('terca')" min="0">
                <p>Pontos: 100 cada</p>
            </div>

            <div class="mission">
                <h2>Quarta-feira - Salva√ß√£o da Alma</h2>
                <label for="quarta_outros">Jovens em outros hor√°rios:</label>
                <input type="number" id="quarta_outros" value="0" oninput="calculateDailyBase('quarta_outros')" min="0">
                <p>Pontos: 30 cada</p>
                <label for="quarta_principal">Jovens na reuni√£o principal (18h):</label>
                <input type="number" id="quarta_principal" value="0" oninput="calculateDailyBase('quarta_principal')" min="0">
                <p>Pontos: 50 cada</p>
            </div>

            <div class="mission">
                <h2>Quinta-feira - Terapia do Amor</h2>
                <label for="quinta">Jovens presentes:</label>
                <input type="number" id="quinta" value="0" oninput="calculateDailyBase('quinta')" min="0">
                <p>Pontos: 50 cada</p>
            </div>

            <h2>S√°bado - Miss√µes</h2>
            <div class="mission">
                <h2>Conex√£o Jovem</h2>
                <label for="sabado">Jovens conectados (11h30):</label>
                <input type="number" id="sabado" value="0" oninput="calculateDailyBase('sabado')" min="0">
                <p>Pontos: 20 cada</p>
            </div>

            <div class="mission">
                <h2>Encontro Jovem (EJ)</h2>
                <label for="ej_novo">Jovens novos que nunca foram ao EJ:</label>
                <input type="number" id="ej_novo" value="0" oninput="calculateDailyBase('ej_novo')" min="0">
                <p>Pontos: 100 cada</p>

                <label for="ej_afastado">Jovens afastados que retornaram ao EJ:</label>
                <input type="number" id="ej_afastado" value="0" oninput="calculateDailyBase('ej_afastado')" min="0">
                <p>Pontos: 60 cada</p>
            </div>

            <div class="mission">
                <h2>Domingo - Concentra√ß√£o de F√©</h2>
                <label for="domingo_150">Jovens presentes (150pts):</label>
                <input type="number" id="domingo_150" value="0" oninput="calculateDailyBase('domingo_150')" min="0">
                <p>Pontos: 150 cada</p>
                <label for="domingo_75">Jovens presentes (75pts):</label>
                <input type="number" id="domingo_75" value="0" oninput="calculateDailyBase('domingo_75')" min="0">
                <p>Pontos: 75 cada</p>
            </div>

            <h2>Desafios Extras / B√¥nus</h2>

            <div class="mission">
                <h2>Manuten√ß√£o do Templo</h2>
                <label for="manutencao_templo">Jovens que ajudaram:</label>
                <input type="number" id="manutencao_templo" value="0" oninput="calculateDailyBase('manutencao_templo')" min="0">
                <p>Pontos: 200 cada jovem</p>
            </div>

            <div class="mission">
                <h2>Doa√ß√£o de Resma de Papel A4</h2>
                <label for="resma_papel">Quantidade de resmas (se cumpriu, digite 1):</label>
                <input type="number" id="resma_papel" value="0" oninput="calculateDailyBase('resma_papel')" min="0">
                <p>Pontos: 700</p>
            </div>

            <div class="mission">
                <h2>Montar Time de Futebol</h2>
                <label for="time_futebol">Cumpriu o desafio? (digite 1):</label>
                <input type="number" id="time_futebol" value="0" oninput="calculateDailyBase('time_futebol')" min="0">
                <p>Pontos: 2.000</p>
            </div>

            <div class="mission">
                <h2>Evangeliza√ß√£o Criativa</h2>
                <label for="evangelizacao_criativa">Cumpriu o desafio? (digite 1):</label>
                <input type="number" id="evangelizacao_criativa" value="0" oninput="calculateDailyBase('evangelizacao_criativa')" min="0">
                <p>Pontos: 1.000</p>
            </div>

            <div class="mission">
                <h2>Ponto de Ora√ß√£o</h2>
                <label for="ponto_oracao">Cumpriu o desafio? (digite 1):</label>
                <input type="number" id="ponto_oracao" value="0" oninput="calculateDailyBase('ponto_oracao')" min="0">
                <p>Pontos: 300</p>
            </div>
            
            <div class="mission">
                <h2>Meta da Tribo (Semana 1)</h2>
                <label for="meta_tribo_semana1">Meta da Semana 1 cumprida? (digite 1 para 10.000 pontos):</label>
                <input type="number" id="meta_tribo_semana1" value="0" oninput="calculateDailyBase('meta_tribo_semana1')" min="0">
                <p>Pontos: 10.000 (apenas para a Semana 1)</p>
            </div>

            <div class="total">
                <h2>Pontua√ß√£o Base Di√°ria (para ser atribu√≠da): <span id="dailyBaseDisplay">0</span></h2>
            </div>

            <div class="button-group">
                <button class="primary-btn" onclick="toggleSection('tribe-scoring-section')">Atribuir Pontua√ß√£o para Tribo</button>
            </div>
        </div>

        <div id="tribe-scoring-section" class="tribe-scoring-section hidden">
            <h2>Atribuir Pontua√ß√£o √† Tribo</h2>
            <p>Pontua√ß√£o Base Atual das Miss√µes: <strong id="currentDailyBase">0</strong></p>

            <label for="tribe-selector">Selecione a Tribo:</label>
            <select id="tribe-selector" onchange="loadTribePoints()">
                <option value="">-- Selecione --</option>
            </select>

            <div id="selected-tribe-inputs" class="hidden">
                <h3><img id="selected-tribe-icon" class="tribe-icon" alt="√çcone da Tribo Selecionada"><span id="selected-tribe-name"></span></h3>
                <label for="tribe_current_base">Pontos Base das Miss√µes (preenchido automaticamente):</label>
                <input type="number" id="tribe_current_base" value="0" disabled>

                <label for="tribe_bonus">B√¥nus da Tribo (Miss√µes Especiais):</label>
                <input type="number" id="tribe_bonus" value="0" min="0">

                <label for="tribe_total_manual">Total Manual (Opcional, para Miss√µes Surpresa ou ajuste):</label>
                <input type="number" id="tribe_total_manual" value="0" min="0">

                <div class="button-group">
                    <button class="primary-btn" onclick="saveTribePoints()">Salvar Pontua√ß√£o da Tribo</button>
                    <button class="danger-btn" onclick="clearSelectedTribeInputs()">Limpar Sele√ß√£o</button>
                </div>
            </div>
        </div>

        <div id="admin-overview-section" class="hidden">
            <h2>Vis√£o Geral do Rally</h2>
            <p style="text-align: center; margin-bottom: 40px;">Acompanhe a pontua√ß√£o atual das tribos e a classifica√ß√£o geral.</p>
            <div class="total-section">
                <div class="tribe-total">
                    <h2><img src="Levi.png" alt="Logo Levi" class="tribe-icon"> Tribo de Levi</h2>
                    <span class="tribe-score" id="admin_score_levi">0</span>
                </div>

                <div class="tribe-total">
                    <h2><img src="Juda.png" alt="Logo Jud√°" class="tribe-icon"> Tribo de Jud√°</h2>
                    <span class="tribe-score" id="admin_score_juda">0</span>
                </div>

                <div class="tribe-total">
                    <h2><img src="Naftali.png" alt="Logo Naftali" class="tribe-icon"> Tribo de Naftali</h2>
                    <span class="tribe-score" id="admin_score_naftali">0</span>
                </div>

                <div class="tribe-total">
                    <h2><img src="Gade.png" alt="Logo Gade" class="tribe-icon"> Tribo de Gade</h2>
                    <span class="tribe-score" id="admin_score_gade">0</span>
                </div>

                <div class="ranking">
                    <h2>Classifica√ß√£o das Tribos (Total)</h2>
                    <ol id="admin_tribes_ranking"></ol>
                </div>

                <div id="admin_leaderDisplay" class="leaderDisplay">
                    <h2>L√≠der Atual:</h2>
                    <span id="admin_leaderName"><span class="leader-text">Nenhuma tribo pontuada</span></span>
                </div>
            </div>
        </div>


        <div id="regulation-section" class="hidden">
            <h2>Regulamento do Rally "O Alvo"</h2>
            <hr>
            <h3>üìå Mec√¢nica do Jogo:</h3>
            <ul>
                <li>As tribos (equipes) acumulam üéØ **ALVOS (pontos)** ao cumprirem miss√µes.</li>
                <li>Miss√µes **SEMANAIS** t√™m valores diferentes.</li>
                <li>Miss√µes especiais d√£o b√¥nus maiores.</li>
            </ul>

            <h3>üìÖ Miss√µes Semanais (06 a 12 de Julho)</h3>

            <h4>üìç SEGUNDA-FEIRA</h4>
            <p>üÖ∞Ô∏è‚ûï **ALGO A MAIS**</p>
            <ul>
                <li>Cada jovem presente na reuni√£o = **50 üéØ**</li>
                <li>Enviar 1 foto da reuni√£o no grupo at√© 22h.</li>
            </ul>

            <h4>üìç TER√áA-FEIRA</h4>
            <p>ü¶∂üèò **P√â NO BAIRRO** (Evangelismo)</p>
            <ul>
                <li>**100 üéØ** por trabalho realizado (m√≠nimo 3 jovens da tribo).</li>
                <li>Enviar 1 foto (c√¢mera deitada) com jornal/folheto da semana.</li>
            </ul>

            <h4>üìç QUARTA-FEIRA</h4>
            <p>üìñüá®üá∑ **SALVA√á√ÉO DA ALMA**</p>
            <ul>
                <li>Jovens nas reuni√µes (outros hor√°rios) = **30 üéØ** cada</li>
                <li>Jovens na reuni√£o principal das 18h = **50 üéØ** cada</li>
            </ul>

            <h4>üìç QUINTA-FEIRA</h4>
            <p>‚ù§Ô∏è‚Äçüî•üá®üá∑ **TERAPIA DO AMOR** (Reuni√£o Principal)</p>
            <ul>
                <li>**50 üéØ** por jovem presente √†s 19h.</li>
            </ul>

            <h4>üìç S√ÅBADO</h4>
            <p>üìªüá®üá∑ **CONEX√ÉO JOVEM**</p>
            <ul>
                <li>**20 üéØ** por jovem conectado (**11h30**).</li>
                <li>FOTO NO GRUPO para comprovar.</li>
            </ul>
            <p>üéØ **ENCONTRO JOVEM** (EJ)</p>
            <ul>
                <li>**100 üéØ** por jovem novo (que nunca foi ao EJ).</li>
                <li>**60 üéØ** por jovem afastado que retornar.</li>
            </ul>

            <h4>üìç DOMINGO</h4>
            <p>‚õ™Ô∏èüá®üá∑ **CONCENTRA√á√ÉO DE F√â**</p>
            <ul>
                <li>**150 üéØ** por jovem presente 9H30.</li>
                <li>**75 üéØ** por jovem presente 9H30.</li>
                <li>FOTO NO GRUPO para comprovar.</li>
            </ul>

            <hr>

            <h3>üî• Miss√µes Especiais (B√¥nus Alto!)</h3>

            <h4>üìç Ponto de Ora√ß√£o</h4>
            <ul>
                <li>**300 üéØ** por tribo que organizar um momento de ora√ß√£o durante a semana.</li>
            </ul>

            <h4>üìç Evangeliza√ß√£o Criativa</h4>
            <ul>
                <li>**1.000 üéØ** para a tribo que fizer uma a√ß√£o evangel√≠stica inovadora (entregas de livros, algo criativo!).</li>
                <li>FOTO NO GRUPO para comprovar.</li>
            </ul>

            <h4>üå≥ Desafio dos Alvos</h4>
            <ul>
                <li>**2.000 üéØ** ‚Äì Montar um time de futebol (m√≠nimo **5 jogadores**). Trazer no encontro.</li>
                <li>**700 üéØ** ‚Äì Doar 1 resma de papel A4.</li>
                <li>**1.000 üéØ** ‚Äì Melhor foto da tribo (dentro ou fora da igreja).</li>
            </ul>

            <h4>üßΩü™£ Manuten√ß√£o do Templo</h4>
            <ul>
                <li>**200 üéØ** por jovem que ajudar na limpeza/organiza√ß√£o no S√°bado (**8h30**).</li>
            </ul>

            <hr>

            <h3>‚ö°Ô∏è Miss√µes Surpresa</h3>
            <ul>
                <li>O l√≠der pode lan√ßar desafios-rel√¢mpago a qualquer momento!</li>
                <li>Valores de üéØ **ALVOS** ser√£o definidos na hora.</li>
            </ul>

            <hr>
            <h3>üèÜ Meta da Tribo</h3>
            <ul>
                <li>1¬™ Semana: Trazer 20 jovens (vale **10.000 pontos**).</li>
            </ul>

            <hr>
            <h3>üéØ Objetivo Final:</h3>
            <p>Manter o foco no Alvo Maior (Cristo) enquanto os jovens se divertem, competem e fortalecem sua comunh√£o!</p>
            <p><em>"Prossigo para o alvo, para o pr√™mio da soberana voca√ß√£o de Deus em Cristo Jesus."</em> (Filipenses 3:14)</p>
        </div>

        <div id="history-section" class="hidden container">
            <h2>Hist√≥rico de Pontua√ß√£o Semanal</h2>
            <p>Acompanhe a evolu√ß√£o de cada tribo semana a semana. O campe√£o ser√° a tribo com a maior pontua√ß√£o acumulada!</p>
            <table id="history-table">
                <thead>
                    <tr>
                        <th>Tribo</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
                <tfoot>
                    <tr class="history-total-row">
                        <td>TOTAL GERAL</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <div id="championAnimation">
        <h2 id="championTitle">üèÜ CAMPE√ÉO üèÜ</h2>
        <div id="championNameAnimated"></div>
    </div>
</div>

<footer>
    <p>&copy; 2025 Rally "O Alvo" - Grupo Jovem.</p>
    <button class="reset-btn-bottom-right hidden" id="admin-reset-button" onclick="confirmResetAllData()">Reiniciar Rally</button>
</footer>

<script>
    // --- IMPORTANTE: SUBSTITUA ESTE LINK PELO SEU URL REAL DO GOOGLE APPS SCRIPT ---
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzk0aItcOEFN7JILBOPJyuhRUH_lWXjpJH6BxCD8F54Hf0k9hgayODAiDxFC7grXzSj/exec';
    const TOTAL_WEEKS = 9; // N√∫mero total de semanas do Rally

    let dailyBasePoints = 0;
    let currentWeekNumber = 1;
    let weekStatus = Array(TOTAL_WEEKS).fill(false); // Status de cada semana (finalizada/n√£o finalizada)
    let authenticatedUser = null; // Para armazenar o usu√°rio logado
    let activeAdminSection = 'daily-missions-section-admin'; // Se√ß√£o ativa por padr√£o na secretaria

    // Objeto para armazenar as pontua√ß√µes e o hist√≥rico semanal
    const tribes = {
        levi: { weeklyScores: Array(TOTAL_WEEKS).fill(0), nameDisplay: "Tribo de Levi", logo: "Levi.png" },
        juda: { weeklyScores: Array(TOTAL_WEEKS).fill(0), nameDisplay: "Tribo de Jud√°", logo: "Juda.png" },
        naftali: { weeklyScores: Array(TOTAL_WEEKS).fill(0), nameDisplay: "Tribo de Naftali", logo: "Naftali.png" },
        gade: { weeklyScores: Array(TOTAL_WEEKS).fill(0), nameDisplay: "Tribo de Gade", logo: "Gade.png" }
    };

    const dailyMissionInputValues = {
        segunda: 0, terca: 0, quarta_outros: 0, quarta_principal: 0, quinta: 0,
        sabado: 0, ej_novo: 0, ej_afastado: 0, domingo_150: 0, domingo_75: 0,
        manutencao_templo: 0, resma_papel: 0, time_futebol: 0, evangelizacao_criativa: 0, ponto_oracao: 0,
        meta_tribo_semana1: 0 // Nova miss√£o
    };

    // Helper functions
    const getInputValue = (id) => parseInt(document.getElementById(id).value) || 0;

    // --- FUN√á√ïES DE AUTENTICA√á√ÉO E CARREGAMENTO DE ESTADO ---
    function openLoginModal() {
        // Limpa os campos de usu√°rio e senha no modal
        document.getElementById('login-username').value = "";
        document.getElementById('login-password').value = "";

        const loginModal = document.getElementById('login-modal');
        loginModal.classList.remove('hidden');
        loginModal.style.display = 'flex'; // Exibe o modal
        document.getElementById('login-message').innerText = '';
    }

    function closeLoginModal() {
        document.getElementById('login-modal').classList.add('hidden'); // Oculta o modal
        document.getElementById('login-modal').style.display = 'none'; // Garante que n√£o interfira no layout
    }

    async function performLogin() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        const loginMessage = document.getElementById('login-message');

        if (!username || !password) {
            loginMessage.innerText = "Por favor, insira usu√°rio e senha.";
            return;
        }

        loginMessage.innerText = "Entrando...";
        loginMessage.style.color = "blue";

        // Credenciais locais para desenvolvimento/fallback (remova em produ√ß√£o se usar apenas Apps Script)
       

        // Se as credenciais locais n√£o baterem, tenta via Apps Script
        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'login',
                    username: username,
                    password: password
                }),
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    authenticatedUser = { username: username, password: password };
                    localStorage.setItem('rallyAuthenticatedUser', JSON.stringify(authenticatedUser));
                    loginMessage.innerText = "Login bem-sucedido! Carregando dados...";
                    loginMessage.style.color = "green";
                    closeLoginModal(); // Fecha o modal
                    await loadRallyStateFromSheet(); // Carrega o estado completo do rally da planilha
                    document.getElementById('public-content').classList.add('hidden');
                    document.getElementById('admin-content').classList.remove('hidden');
                    document.getElementById('admin-reset-button').classList.remove('hidden');
                    updateAdminTribeDisplays(); // Atualiza os displays de pontua√ß√£o no painel admin
                    updateAdminRanking(); // Atualiza o ranking no painel admin
                    updateWeekSelector(); // Popula o seletor de semana
                    toggleSection('daily-missions-section-admin'); // Vai para a tela de pontua√ß√£o di√°ria
                } else {
                    loginMessage.innerText = result.message || "Usu√°rio ou senha inv√°lidos.";
                    loginMessage.style.color = "red";
                }
            } else {
                loginMessage.innerText = "Erro no servidor de autentica√ß√£o. Status: " + response.status;
                loginMessage.style.color = "red";
                console.error("Erro no Apps Script (HTTP Status):", response.status, response.statusText);
            }

        } catch (error) {
            console.error('Erro ao tentar login (rede/JSON):', error);
            loginMessage.innerText = "Erro ao conectar. Verifique sua conex√£o ou URL do Apps Script.";
            loginMessage.style.color = "red";
        }
    }

    async function loadRallyStateFromSheet() {
        if (authenticatedUser) {
            // Apenas mostra a mensagem de carregamento se for login autenticado, n√£o para o p√∫blico
            const loginMessage = document.getElementById('login-message');
            if (loginMessage) { // Verifica se o elemento existe (estamos no modal de login)
                loginMessage.innerText = "Carregando dados do rally...";
                loginMessage.style.color = "blue";
            }
        }
        
        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'loadState',
                    username: authenticatedUser ? authenticatedUser.username : "public",
                    password: authenticatedUser ? authenticatedUser.password : "public"
                }),
            });

            if (response.ok) {
                const result = await response.json();
                if (result.status === "success" && result.state) {
                    currentWeekNumber = result.state.currentWeekNumber;
                    
                    weekStatus = result.state.weekStatus;
                    // Garante que weekStatus tenha o tamanho correto
                    while (weekStatus.length < TOTAL_WEEKS) {
                        weekStatus.push(false);
                    }
                    
                    for (const tribeId in tribes) {
                        if (result.state.tribes[tribeId]) {
                            // Garante que weeklyScores tenha o tamanho correto
                            while (result.state.tribes[tribeId].weeklyScores.length < TOTAL_WEEKS) {
                                result.state.tribes[tribeId].weeklyScores.push(0);
                            }
                            tribes[tribeId].weeklyScores = result.state.tribes[tribeId].weeklyScores.slice(0, TOTAL_WEEKS);
                        } else {
                            // Se a tribo n√£o existe no estado, inicializa com zeros
                            tribes[tribeId].weeklyScores = Array(TOTAL_WEEKS).fill(0);
                        }
                    }
                    
                    updatePublicDisplays(); // Atualiza os displays p√∫blicos
                    
                    if (authenticatedUser) {
                        updateAdminTribeDisplays(); // Atualiza os displays de pontua√ß√£o no painel admin
                        updateAdminRanking(); // Atualiza o ranking no painel admin
                        document.getElementById('current-week-display').innerText = currentWeekNumber;
                        document.getElementById('daily-mission-current-week').innerText = currentWeekNumber;
                        document.getElementById('current-week-number-display-selection').innerText = currentWeekNumber; // Para o seletor de semana
                        document.getElementById('total-weeks-display').innerText = TOTAL_WEEKS; // Atualiza o total de semanas
                        updateWeekSelector(); // Certifica-se que o seletor de semana est√° atualizado
                        // Remove a mensagem de carregamento do login modal
                        const loginMessage = document.getElementById('login-message');
                        if (loginMessage) {
                             loginMessage.innerText = "Dados carregados.";
                             loginMessage.style.color = "green";
                        }
                    }

                } else {
                    console.error("Erro ao carregar dados do rally (Apps Script): " + (result.message || "Resposta inv√°lida."));
                    const loginMessage = document.getElementById('login-message');
                    if (loginMessage) {
                        loginMessage.innerText = "Erro ao carregar dados. Tente novamente.";
                        loginMessage.style.color = "red";
                    }
                }
            } else {
                console.error("Erro ao conectar com o servidor para carregar dados. Status: " + response.status);
                const loginMessage = document.getElementById('login-message');
                if (loginMessage) {
                    loginMessage.innerText = "Erro de conex√£o ao carregar dados.";
                    loginMessage.style.color = "red";
                }
            }
        } catch (error) {
            console.error('Erro ao carregar estado do rally da planilha (rede/JSON):', error);
            const loginMessage = document.getElementById('login-message');
            if (loginMessage) {
                loginMessage.innerText = "Erro na rede ou ao processar dados.";
                loginMessage.style.color = "red";
            }
        }
    }

    function performLogout() {
        authenticatedUser = null;
        localStorage.removeItem('rallyAuthenticatedUser');
        alert("Voc√™ foi desconectado.");
        document.getElementById('public-content').classList.remove('hidden');
        document.getElementById('admin-content').classList.add('hidden');
        document.getElementById('admin-reset-button').classList.add('hidden');
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('login-message').innerText = '';
        resetAllLocalData(); // Zera os dados locais para n√£o vazar informa√ß√µes
        loadRallyStateFromSheet(); // Recarrega os dados p√∫blicos
    }

    // --- Fun√ß√µes de Navega√ß√£o para o ADMIN ---
    function hideAllAdminSections() {
        document.getElementById('daily-missions-section-admin').classList.add('hidden');
        document.getElementById('tribe-scoring-section').classList.add('hidden');
        document.getElementById('regulation-section').classList.add('hidden');
        document.getElementById('history-section').classList.add('hidden');
        document.getElementById('admin-overview-section').classList.add('hidden'); // Nova se√ß√£o
        document.getElementById('championAnimation').style.display = 'none'; // Garante que a anima√ß√£o seja escondida

        // Remove a classe 'active' de todos os bot√µes de aba
        const navButtons = document.querySelectorAll('.admin-nav-tabs button');
        navButtons.forEach(button => button.classList.remove('active'));
    }

    // Esta fun√ß√£o agora √© o "master" para exibir e ocultar se√ß√µes e bot√µes
    function toggleSection(sectionId) {
        const currentActiveSectionElement = document.getElementById(activeAdminSection);
        const newSectionElement = document.getElementById(sectionId);
        const clickedButton = document.getElementById(`tab-${sectionId}`);
        
        // --- L√≥gica para fechar a se√ß√£o atual e voltar para Pontua√ß√£o Di√°ria ---
        if (currentActiveSectionElement && currentActiveSectionElement.id === sectionId) {
            // Se a se√ß√£o clicada j√° est√° ativa, e n√£o √© a de atribui√ß√£o de tribo (que se fecha de outro jeito)
            // volta para a tela de Pontua√ß√£o Di√°ria
            if (sectionId !== 'tribe-scoring-section') {
                hideAllAdminSections();
                document.getElementById('daily-missions-section-admin').classList.remove('hidden');
                document.getElementById('tab-daily-missions-section-admin').classList.add('active');
                activeAdminSection = 'daily-missions-section-admin';
                resetDailyMissionInputs();
                document.getElementById('daily-mission-current-week').innerText = currentWeekNumber;
                document.getElementById('selected-tribe-inputs').classList.add('hidden');
                document.getElementById('tribe-selector').value = "";
                return;
            }
        }

        // --- L√≥gica de redirecionamento para Atribuir Pontua√ß√£o ---
        // Se tentar ir para tribe-scoring-section sem ter vindo do bot√£o de c√°lculo di√°rio
        if (sectionId === 'tribe-scoring-section' && currentActiveSectionElement.id !== 'daily-missions-section-admin') {
            alert("Por favor, preencha a Pontua√ß√£o Di√°ria antes de atribuir pontos √† tribo.");
            toggleSection('daily-missions-section-admin'); // Redireciona para a se√ß√£o correta
            return;
        }


        // Esconde todas as se√ß√µes e remove 'active' de todos os bot√µes
        hideAllAdminSections();

        // Mostra a nova se√ß√£o e ativa seu bot√£o
        newSectionElement.classList.remove('hidden');
        activeAdminSection = sectionId;
        if (clickedButton) {
            clickedButton.classList.add('active');
        }

        // L√≥gicas espec√≠ficas ao abrir cada se√ß√£o
        if (sectionId === 'daily-missions-section-admin') {
            resetDailyMissionInputs();
            populateTribeSelector();
            document.getElementById('daily-mission-current-week').innerText = currentWeekNumber;
            document.getElementById('selected-tribe-inputs').classList.add('hidden'); // Esconde ao voltar
            document.getElementById('tribe-selector').value = ""; // Limpa sele√ß√£o ao voltar
        } else if (sectionId === 'tribe-scoring-section') {
            document.getElementById('currentDailyBase').innerText = dailyBasePoints;
            document.getElementById('selected-tribe-inputs').classList.add('hidden'); // Oculta at√© uma tribo ser selecionada
            populateTribeSelector();
        } else if (sectionId === 'history-section') {
            updateHistoryDisplay();
        } else if (sectionId === 'admin-overview-section') {
            updateAdminTribeDisplays();
            updateAdminRanking();
        } else if (sectionId === 'championAnimation') {
            displayChampionAnimation();
        }
    }


    function displayChampionAnimation() {
        const championAnimationDiv = document.getElementById('championAnimation');
        
        const sortedTribes = Object.keys(tribes)
            .filter(key => Object.prototype.hasOwnProperty.call(tribes, key))
            .map(key => ({
                name: tribes[key].nameDisplay,
                score: tribes[key].weeklyScores.reduce((sum, score) => sum + score, 0),
                id: key,
                logo: tribes[key].logo
            }))
            .sort((a, b) => b.score - a.score);

        if (sortedTribes.length > 0 && sortedTribes[0].score > 0) {
            const championTribeName = sortedTribes[0].name;
            const championTribeLogo = sortedTribes[0].logo;

            championAnimationDiv.style.display = 'flex'; 

            document.getElementById('championNameAnimated').innerHTML = `
                <img src="${championTribeLogo}" alt="Logo Campe√£o" class="tribe-icon">
                <span>${championTribeName}</span>
            `;

            const existingConfetti = championAnimationDiv.querySelectorAll('.confetti');
            existingConfetti.forEach(confetti => confetti.remove());

            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = getRandomColor();
                confetti.style.setProperty('--random-x', `${Math.random() * 100}vw`);
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                confetti.style.animationDuration = `${2 + Math.random() * 1}s`;
                championAnimationDiv.appendChild(confetti);
            }
        } else {
            alert("Nenhuma tribo pontuada ainda para determinar um campe√£o! Lance os pontos das semanas para ver quem vence.");
            toggleSection('daily-missions-section-admin');
        }
    }


    // --- Week Management (Adaptado para comunica√ß√£o com Apps Script) ---
    function updateWeekSelector() {
        const weekSelector = document.getElementById('week-selector');
        weekSelector.innerHTML = '';
        for (let i = 1; i <= TOTAL_WEEKS; i++) {
            const option = document.createElement('option');
            option.value = i;
            // Adapta o texto para indicar se a semana √© a atual, finalizada ou n√£o finalizada
            let statusText = '';
            if (i === currentWeekNumber) {
                   statusText = ' (Atual)';
            } else if (i < currentWeekNumber && !weekStatus[i - 1]) { // Passada e n√£o finalizada
                statusText = ' (N√£o Finalizada)';
            } else if (weekStatus[i - 1]) { // Finalizada
                statusText = ' (Finalizada)';
            }
            
            option.innerText = `Semana ${i}${statusText}`;
            weekSelector.appendChild(option);
        }
        weekSelector.value = currentWeekNumber; // Garante que a semana atual esteja selecionada no dropdown
        document.getElementById('current-week-display').innerText = currentWeekNumber;
        document.getElementById('daily-mission-current-week').innerText = currentWeekNumber;
        document.getElementById('current-week-number-display-selection').innerText = currentWeekNumber;
    }

    async function confirmChangeWeek() {
        const weekSelector = document.getElementById('week-selector');
        const newWeek = parseInt(weekSelector.value);
        const oldWeek = currentWeekNumber;

        if (newWeek === oldWeek) {
            return; // Nenhuma mudan√ßa real, n√£o faz nada
        }

        let actionSuccessful = false;

        // Caso 1: Tentando reabrir semana (selecionou uma semana anterior que est√° marcada como finalizada)
        if (newWeek < oldWeek && weekStatus[newWeek - 1]) {
            const confirmReopen = confirm(`A Semana ${newWeek} foi marcada como FINALIZADA.\n\nTem certeza que deseja REABRIR esta semana para edi√ß√£o? Isso permitir√° alterar as pontua√ß√µes dela e atualizar√° a planilha.`);
            if (confirmReopen) {
                const result = await sendToAppsScript('reopenWeek', { weekNumber: newWeek });
                if (result.status === "success") {
                    // Ap√≥s reabrir no Apps Script, a semana selecionada se torna a "currentWeekNumber"
                    currentWeekNumber = newWeek;
                    weekStatus[newWeek - 1] = false; // Atualiza o status localmente para 'n√£o finalizada'
                    alert(`Semana ${newWeek} reaberta para edi√ß√£o e definida como semana atual.`);
                    actionSuccessful = true;
                } else {
                    alert("Erro ao reabrir semana na planilha: " + (result.message || "Erro desconhecido."));
                }
            }
        } 
        // Caso 2: Tentando avan√ßar para uma semana futura (e a semana atual n√£o precisa ser finalizada para isso)
        else if (newWeek > oldWeek) {
            let confirmAdvance = true;
            if (!weekStatus[oldWeek - 1] && oldWeek < TOTAL_WEEKS) { // Se a semana atual N√ÉO est√° finalizada, alerta o usu√°rio, mas s√≥ se n√£o for a √∫ltima semana
                confirmAdvance = confirm(`A Semana ${oldWeek} N√ÉO foi finalizada.\n\nAo avan√ßar para a Semana ${newWeek} sem finalizar a Semana ${oldWeek}, voc√™ ainda poder√° editar a Semana ${oldWeek} mais tarde.\n\nContinuar?`);
            }
            if (confirmAdvance) {
                const result = await sendToAppsScript('advanceWeek', { newWeekNumber: newWeek });
                if (result.status === "success") {
                    currentWeekNumber = newWeek;
                    alert(`Avan√ßado para a Semana ${newWeek}.`);
                    actionSuccessful = true;
                } else {
                    alert("Erro ao avan√ßar semana na planilha: " + (result.message || "Erro desconhecido."));
                }
            }
        }
        // Caso 3: Selecionando uma semana anterior que J√Å EST√Å n√£o finalizada (apenas muda a weekNumber localmente e no Apps Script)
        else if (newWeek < oldWeek && !weekStatus[newWeek - 1]) {
             // N√£o precisa de confirma√ß√£o extra, pois j√° est√° n√£o finalizada e apenas a estamos tornando atual
             const result = await sendToAppsScript('advanceWeek', { newWeekNumber: newWeek }); // Usa advanceWeek para mudar currentWeek
             if (result.status === "success") {
                 currentWeekNumber = newWeek;
                 alert(`A semana ${newWeek} foi selecionada como a semana atual.`);
                 actionSuccessful = true;
             } else {
                 alert("Erro ao mudar para a semana anterior: " + (result.message || "Erro desconhecido."));
             }
        }

        if (actionSuccessful) {
            // Recarrega o estado completo para garantir que os dados de pontua√ß√£o para a 'newWeek' sejam carregados
            await loadRallyStateFromSheet(); 
            // Atualiza todos os displays de semana e zera os inputs di√°rios
            document.getElementById('current-week-display').innerText = currentWeekNumber;
            document.getElementById('daily-mission-current-week').innerText = currentWeekNumber;
            document.getElementById('current-week-number-display-selection').innerText = currentWeekNumber;
            
            resetDailyMissionInputs(); // Limpa os inputs da pontua√ß√£o di√°ria ao mudar de semana
            dailyBasePoints = 0;
            document.getElementById('dailyBaseDisplay').innerText = 0;
            
            updatePublicDisplays(); // Atualiza os dados p√∫blicos
            updateAdminTribeDisplays(); // Atualiza os dados do admin
            updateAdminRanking(); // Atualiza o ranking do admin
            updateWeekSelector(); // Re-popula o seletor para refletir o status da semana
            toggleSection('daily-missions-section-admin'); // Volta para a tela de pontua√ß√£o di√°ria
        } else {
            weekSelector.value = oldWeek; // Volta a sele√ß√£o para a semana anterior se a a√ß√£o falhou ou foi cancelada
        }
    }


    // --- Calculate Daily Base Score ---
    function calculateDailyBase(inputName) {
        dailyMissionInputValues[inputName] = getInputValue(inputName);
        let total = 0;
        total += dailyMissionInputValues.segunda * 50;
        total += dailyMissionInputValues.terca * 100;
        total += dailyMissionInputValues.quarta_outros * 30;
        total += dailyMissionInputValues.quarta_principal * 50;
        total += dailyMissionInputValues.quinta * 50;
        total += dailyMissionInputValues.sabado * 20;
        total += dailyMissionInputValues.ej_novo * 100;
        total += dailyMissionInputValues.ej_afastado * 60;
        total += dailyMissionInputValues.domingo_150 * 150;
        total += dailyMissionInputValues.domingo_75 * 75;
        total += dailyMissionInputValues.manutencao_templo * 200;
        total += dailyMissionInputValues.resma_papel * 700;
        total += dailyMissionInputValues.time_futebol * 2000;
        total += dailyMissionInputValues.evangelizacao_criativa * 1000;
        total += dailyMissionInputValues.ponto_oracao * 300;
        
        // Adiciona a meta da tribo apenas se for a primeira semana e o valor for 1
        if (currentWeekNumber === 1 && dailyMissionInputValues.meta_tribo_semana1 === 1) {
            total += 10000;
        }

        dailyBasePoints = total;
        document.getElementById('dailyBaseDisplay').innerText = dailyBasePoints;
    }

    // --- Manage Individual Tribe Scoring ---
    function populateTribeSelector() {
        const tribeSelector = document.getElementById('tribe-selector');
        tribeSelector.innerHTML = '<option value="">-- Selecione --</option>';
        for (const tribeId in tribes) {
            if (Object.prototype.hasOwnProperty.call(tribes, tribeId)) {
                const option = document.createElement('option');
                option.value = tribeId;
                option.innerText = tribes[tribeId].nameDisplay;
                tribeSelector.appendChild(option);
            }
        }
        tribeSelector.value = "";
        document.getElementById('selected-tribe-inputs').classList.add('hidden');
    }

    function loadTribePoints() {
        const selectedTribeId = document.getElementById('tribe-selector').value;
        const selectedTribeInputsDiv = document.getElementById('selected-tribe-inputs');
        const selectedTribeIcon = document.getElementById('selected-tribe-icon');

        if (selectedTribeId === "") {
            selectedTribeInputsDiv.classList.add('hidden');
            return;
        }

        selectedTribeInputsDiv.classList.remove('hidden');
        document.getElementById('selected-tribe-name').innerText = tribes[selectedTribeId].nameDisplay;
        selectedTribeIcon.src = tribes[selectedTribeId].logo;
        selectedTribeIcon.alt = `Logo ${tribes[selectedTribeId].nameDisplay}`;

        document.getElementById('tribe_current_base').value = dailyBasePoints;

        // Ao carregar, carregue o valor existente daquela tribo para aquela semana
        const currentScoreForTribeInWeek = tribes[selectedTribeId].weeklyScores[currentWeekNumber - 1];
        if (typeof currentScoreForTribeInWeek !== 'undefined' && currentScoreForTribeInWeek !== 0) {
            // Para simplificar a UX, ao carregar, preenchemos o "Total Manual"
            // Se o usu√°rio quiser recalcular com base e b√¥nus, ele deve limpar.
            document.getElementById('tribe_total_manual').value = currentScoreForTribeInWeek;
            document.getElementById('tribe_bonus').value = 0; // O b√¥nus √© subsumido no total manual ao carregar
        } else {
            document.getElementById('tribe_bonus').value = 0;
            document.getElementById('tribe_total_manual').value = 0;
        }
    }

    async function saveTribePoints() {
        const selectedTribeId = document.getElementById('tribe-selector').value;
        if (selectedTribeId === "") {
            alert("Por favor, selecione uma tribo antes de salvar!");
            return;
        }

        const currentBase = dailyBasePoints;
        const bonus = getInputValue('tribe_bonus');
        const manualTotal = getInputValue('tribe_total_manual');
        let pointsToAdd = 0;
        let isManualEntry = false;

        if (manualTotal > 0) {
            pointsToAdd = manualTotal;
            isManualEntry = true;
        } else {
            pointsToAdd = currentBase + bonus;
        }

        // Antes de atualizar localmente, pegamos a pontua√ß√£o antiga para enviar ao Apps Script
        const oldScoreForTribeInWeek = tribes[selectedTribeId].weeklyScores[currentWeekNumber - 1] || 0;
        
        // Atualiza a pontua√ß√£o no objeto local IMEDIATAMENTE (para feedback visual)
        tribes[selectedTribeId].weeklyScores[currentWeekNumber - 1] = pointsToAdd;

        const result = await sendToAppsScript('Lan√ßamentos Di√°rios', {
            tribeId: selectedTribeId, // Envia o ID da tribo (levi, juda, etc.)
            tribeName: tribes[selectedTribeId].nameDisplay, // Nome para refer√™ncia
            score: pointsToAdd, // Pontua√ß√£o total para a semana
            week: currentWeekNumber, // N√∫mero da semana
            bonus: isManualEntry ? 0 : bonus, // B√¥nus s√≥ √© relevante se n√£o for entrada manual
            manualTotal: isManualEntry ? manualTotal : 0, // Total manual se usado
            oldScore: oldScoreForTribeInWeek, // Pontua√ß√£o anterior para c√°lculo de diferen√ßa no script
            details: JSON.stringify(dailyMissionInputValues), // Detalhes das miss√µes di√°rias
            date: new Date().toLocaleDateString('pt-BR'),
            time: new Date().toLocaleTimeString('pt-BR')
        });

        if (result.status === "success") {
            alert(`Pontua√ß√£o para ${tribes[selectedTribeId].nameDisplay} atualizada e enviada para a aba 'Lan√ßamentos Di√°rios'!`);
            // Recarrega o estado completo para garantir que as pontua√ß√µes e rankings sejam atualizados globalmente
            await loadRallyStateFromSheet();
            resetDailyMissionInputs();
            clearSelectedTribeInputs(); // Usa a fun√ß√£o para limpar corretamente
            toggleSection('daily-missions-section-admin'); // Volta para a tela de miss√µes di√°rias
        } else {
            // Reverte a pontua√ß√£o local se o Apps Script falhar
            tribes[selectedTribeId].weeklyScores[currentWeekNumber - 1] = oldScoreForTribeInWeek;
            alert("Erro ao salvar pontua√ß√£o da tribo: " + (result.message || "Erro desconhecido."));
            console.error("Detalhes do erro ao salvar pontua√ß√£o:", result.message); // Log mais detalhado
        }
    }

    function clearSelectedTribeInputs() {
        document.getElementById('tribe-selector').value = "";
        document.getElementById('selected-tribe-inputs').classList.add('hidden');
        document.getElementById('tribe_bonus').value = 0;
        document.getElementById('tribe_total_manual').value = 0;
        // N√£o chame populateTribeSelector aqui, pois ele j√° √© chamado quando a se√ß√£o √© exibida ou ao mudar de semana
        // Ele deve ser chamado apenas quando o select √© esvaziado para resetar
        // Ou quando os dados de tribos s√£o atualizados. A chamada em toggleSection j√° cuida disso.
    }

    function resetDailyMissionInputs() {
        document.getElementById('segunda').value = 0;
        document.getElementById('terca').value = 0;
        document.getElementById('quarta_outros').value = 0;
        document.getElementById('quarta_principal').value = 0;
        document.getElementById('quinta').value = 0;
        document.getElementById('sabado').value = 0;
        document.getElementById('ej_novo').value = 0;
        document.getElementById('ej_afastado').value = 0;
        document.getElementById('domingo_150').value = 0;
        document.getElementById('domingo_75').value = 0;
        document.getElementById('manutencao_templo').value = 0;
        document.getElementById('resma_papel').value = 0;
        document.getElementById('time_futebol').value = 0;
        document.getElementById('evangelizacao_criativa').value = 0;
        document.getElementById('ponto_oracao').value = 0;
        document.getElementById('meta_tribo_semana1').value = 0; // Resetar nova miss√£o

        for (const key in dailyMissionInputValues) {
            if (Object.prototype.hasOwnProperty.call(dailyMissionInputValues, key)) {
                dailyMissionInputValues[key] = 0;
            }
        }
        dailyBasePoints = 0;
        document.getElementById('dailyBaseDisplay').innerText = 0;
    }

    // --- Reset All Data (comunica√ß√£o com Apps Script) ---
    async function confirmResetAllData() {
        const confirmText = "Tem certeza que quer zerar TODOS os dados do Rally na PLANILHA GOOGLE E NO SITE? As pontua√ß√µes semanais de TODAS as tribos e o hist√≥rico ser√£o apagados! ESTA A√á√ÉO √â IRREVERS√çVEL.";
        const confirmReset = confirm(confirmText);

        if (confirmReset) {
            const result = await sendToAppsScript('resetAllData', {});
            if (result.status === "success") {
                resetAllLocalData(); // Zera dados locais primeiro
                alert("Rally Reiniciado! Todas as pontua√ß√µes e semana resetadas.");
                await loadRallyStateFromSheet(); // Recarrega o estado limpo do sheet
                updatePublicDisplays(); // Atualiza os dados p√∫blicos
                updateAdminTribeDisplays(); // Atualiza os dados do admin
                updateAdminRanking(); // Atualiza o ranking do admin
                updateWeekSelector(); // Atualiza o seletor de semana
                toggleSection('daily-missions-section-admin'); // Volta para a tela principal da secretaria
            } else {
                alert("Erro ao reiniciar o Rally na planilha: " + (result.message || "Erro desconhecido."));
                console.error("Detalhes do erro ao reiniciar Rally:", result.message);
            }
        } else {
            alert("A opera√ß√£o de rein√≠cio foi cancelada.");
        }
    }

    function resetAllLocalData() {
        for (const tribeId in tribes) {
            tribes[tribeId].weeklyScores = Array(TOTAL_WEEKS).fill(0);
        }
        weekStatus.fill(false);
        currentWeekNumber = 1;
        resetDailyMissionInputs();
    }

    // --- Functions for Display and Ranking Updates (P√∫blico e Admin) ---
    function updatePublicDisplays() {
        const totalScores = {};
        for (const tribeId in tribes) {
            totalScores[tribeId] = tribes[tribeId].weeklyScores.reduce((sum, score) => sum + score, 0);
        }
        document.getElementById('score_levi').innerText = totalScores.levi;
        document.getElementById('score_juda').innerText = totalScores.juda;
        document.getElementById('score_naftali').innerText = totalScores.naftali;
        document.getElementById('score_gade').innerText = totalScores.gade;

        updateRanking('tribes_ranking', 'leaderName'); // Atualiza o ranking p√∫blico
    }

    // Nova fun√ß√£o para atualizar os displays no painel admin
    function updateAdminTribeDisplays() {
        const totalScores = {};
        for (const tribeId in tribes) {
            totalScores[tribeId] = tribes[tribeId].weeklyScores.reduce((sum, score) => sum + score, 0);
        }
        document.getElementById('admin_score_levi').innerText = totalScores.levi;
        document.getElementById('admin_score_juda').innerText = totalScores.juda;
        document.getElementById('admin_score_naftali').innerText = totalScores.naftali;
        document.getElementById('admin_score_gade').innerText = totalScores.gade;

        updateRanking('admin_tribes_ranking', 'admin_leaderName'); // Atualiza o ranking do admin
    }

    // Fun√ß√£o √∫nica para ranking, agora parametrizada para uso p√∫blico e admin
    function updateRanking(listId, leaderNameId) {
        const sortedTribes = Object.keys(tribes)
            .filter(key => Object.prototype.hasOwnProperty.call(tribes, key))
            .map(key => ({
                name: tribes[key].nameDisplay,
                score: tribes[key].weeklyScores.reduce((sum, score) => sum + score, 0),
                id: key,
                logo: tribes[key].logo
            }))
            .sort((a, b) => b.score - a.score);

        const rankingList = document.getElementById(listId);
        if (!rankingList) return; // Garante que o elemento exista

        rankingList.innerHTML = '';

        sortedTribes.forEach((tribe, index) => {
            const listItem = document.createElement('li');
            let trophy = '';
            if (index === 0) {
                trophy = '&#x1F3C6;';
            } else if (index === 1) {
                trophy = '&#x1F948;';
            } else if (index === 2) {
                trophy = '&#x1F949;';
            } else {
                trophy = '&#x1F3C5;';
            }
            listItem.innerHTML = `
                <span class="trophy">${trophy}</span>
                <span class="tribe-rank-name-group">
                    <img src="${tribe.logo}" alt="Logo ${tribe.name}" class="tribe-icon">
                    <span class="tribe-name-text">${index + 1}¬∫ ${tribe.name}</span>
                </span>
                <span class="tribe-rank-score">${tribe.score}</span>
            `;
            rankingList.appendChild(listItem);
        });

        const leaderNameSpan = document.getElementById(leaderNameId);
        if (leaderNameSpan) {
            if (sortedTribes.length > 0 && sortedTribes[0].score > 0) {
                const leaderTribe = sortedTribes[0];
                leaderNameSpan.innerHTML = `<img src="${leaderTribe.logo}" alt="Logo L√≠der" class="leader-icon"><span class="leader-text">${leaderTribe.name}</span>`;
            } else {
                leaderNameSpan.innerHTML = '<span class="leader-text">Nenhuma tribo pontuada</span>';
            }
        }
    }

    function getRandomColor() {
        const colors = [
            '#FFC107', /* Amarelo Destaque */
            '#28A745', /* Verde Destaque */
            '#007BFF', /* Azul Claro */
            '#FFFFFF', /* Branco */
            '#FF4500', /* Vermelho-Alaranjado para pop */
            '#9932CC'  /* Roxo M√©dio para variedade */
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    // --- Core Logic for Ending Week ---
    async function confirmEndWeek() {
        if (currentWeekNumber > TOTAL_WEEKS) {
            alert("Todas as semanas j√° foram conclu√≠das! O Rally terminou.");
            return;
        }
        
        // Verifica se todas as tribos t√™m pontua√ß√£o para a semana atual (n√£o zero)
        let allTribesScored = true;
        for (const tribeId in tribes) {
            if (tribes[tribeId].weeklyScores[currentWeekNumber - 1] === 0) {
                allTribesScored = false;
                break;
            }
        }

        if (!allTribesScored) {
            const continueAnyway = confirm("Nem todas as tribos receberam pontua√ß√£o para esta semana. Deseja finalizar a semana assim mesmo? (As tribos sem pontua√ß√£o ficar√£o com 0)");
            if (!continueAnyway) {
                alert("Finaliza√ß√£o da semana cancelada.");
                return;
            }
        }

        const confirmText = `Voc√™ tem certeza que deseja FINALIZAR a Semana ${currentWeekNumber}?\n\nIsso salvar√° a pontua√ß√£o TOTAL de todas as tribos para esta semana na planilha e avan√ßar√° para a pr√≥xima semana.\n\nESTA A√á√ÉO N√ÉO PODE SER DESFEITA FACILMENTE NA PLANILHA.`;
        const confirmEnd = confirm(confirmText);

        if (confirmEnd) {
            const dadosSemanaisParaEnvio = Object.keys(tribes).map(tribeId => {
                return {
                    weekNumber: currentWeekNumber, // Envia apenas o n√∫mero da semana
                    tribeName: tribes[tribeId].nameDisplay,
                    totalScore: tribes[tribeId].weeklyScores[currentWeekNumber - 1] // Pontua√ß√£o j√° acumulada para a semana
                };
            });

            const result = await sendToAppsScript('salvarSemanal', {
                dadosSemanais: dadosSemanaisParaEnvio,
                currentWeekNumber: currentWeekNumber // Envia a semana atual para o Apps Script
            });

            if (result.status === "success") {
                alert(`Pontua√ß√£o da Semana ${currentWeekNumber} salva com sucesso na aba 'Pontua√ß√£o Semanal' na sua planilha!`);
                weekStatus[currentWeekNumber - 1] = true;
                
                if (currentWeekNumber < TOTAL_WEEKS) {
                    currentWeekNumber++;
                    alert(`Avan√ßado para a Semana ${currentWeekNumber}.`);
                } else {
                    alert("Todas as semanas foram conclu√≠das! O Rally terminou. Verifique o Campe√£o Final!");
                }
                resetDailyMissionInputs();
                await loadRallyStateFromSheet(); // Recarrega para refletir a nova semana e status
                toggleSection('daily-missions-section-admin'); // Volta para a tela de miss√µes di√°rias
            } else {
                alert("Erro ao salvar a pontua√ß√£o semanal: " + (result.message || "Erro desconhecido."));
                console.error('Erro ao salvar semanal:', result);
            }
        } else {
            alert("A finaliza√ß√£o da semana foi cancelada.");
        }
    }

    // --- Nova Fun√ß√£o para Comunica√ß√£o com Apps Script ---
    async function sendToAppsScript(action, payload) {
        if (!authenticatedUser) {
            alert("Voc√™ n√£o est√° logado. Por favor, fa√ßa login para realizar esta a√ß√£o.");
            return { status: "error", message: "N√£o logado." };
        }

        const dataToSend = {
            action: action,
            username: authenticatedUser.username,
            password: authenticatedUser.password,
            ...payload
        };

        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend),
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error(`Erro na resposta do servidor para a a√ß√£o '${action}': Status ${response.status}, Resposta: ${errorText}`);
                throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
            }

            return await response.json();
        } catch (error) {
            console.error(`Erro ao enviar a√ß√£o '${action}' para Apps Script:`, error);
            return { status: "error", message: `Falha na conex√£o ou erro de rede para ${action}. Verifique o console para mais detalhes.` };
        }
    }

    // --- Hist√≥rico de Pontua√ß√£o Semanal ---
    async function updateHistoryDisplay() {
        const historyTableBody = document.querySelector('#history-table tbody');
        const historyTableHead = document.querySelector('#history-table thead tr');
        const historyTableFoot = document.querySelector('#history-table tfoot tr');

        // Limpa o cabe√ßalho existente (exceto a primeira coluna 'Tribo')
        while (historyTableHead.children.length > 1) {
            historyTableHead.removeChild(historyTableHead.lastChild);
        }
        // Limpa o rodap√© existente (exceto a primeira coluna 'TOTAL GERAL')
        while (historyTableFoot.children.length > 1) {
            historyTableFoot.removeChild(historyTableFoot.lastChild);
        }
        historyTableBody.innerHTML = ''; // Limpa o corpo da tabela

        // Adiciona as colunas de semanas ao cabe√ßalho e ao rodap√©
        for (let i = 1; i <= TOTAL_WEEKS; i++) {
            const th = document.createElement('th');
            th.innerText = `Semana ${i}`;
            historyTableHead.appendChild(th);

            const td = document.createElement('td');
            td.id = `total_semana_historico_${i}`; // ID para atualizar o total de cada semana no hist√≥rico
            td.innerText = '0'; // Valor inicial
            historyTableFoot.appendChild(td);
        }

        // Adiciona o cabe√ßalho 'Total Acumulado' para o rodap√© e o cabe√ßalho
        const thTotalAcumulado = document.createElement('th');
        thTotalAcumulado.innerText = 'Total Acumulado';
        historyTableHead.appendChild(thTotalAcumulado);

        const tdTotalGeralAcumulado = document.createElement('td');
        tdTotalGeralAcumulado.id = 'total_geral_acumulado_historico';
        historyTableFoot.appendChild(tdTotalGeralAcumulado);


        // Preenche o corpo da tabela com as pontua√ß√µes das tribos
        let overallGrandTotal = 0; // Para o total geral no rodap√©
        for (const tribeId in tribes) {
            if (Object.prototype.hasOwnProperty.call(tribes, tribeId)) {
                const tribe = tribes[tribeId];
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.innerHTML = `<div style="display:flex; align-items:center; gap: 8px;"><img src="${tribe.logo}" alt="Logo ${tribe.nameDisplay}" class="tribe-icon" style="width:25px; height:25px;"> ${tribe.nameDisplay}</div>`;
                row.appendChild(nameCell);

                let totalTribeScore = 0;
                for (let i = 0; i < TOTAL_WEEKS; i++) {
                    const score = tribe.weeklyScores[i] || 0;
                    const scoreCell = document.createElement('td');
                    scoreCell.innerText = score;
                    row.appendChild(scoreCell);
                    totalTribeScore += score;
                }
                const totalCell = document.createElement('td'); // C√©lula para o total acumulado da tribo
                totalCell.innerText = totalTribeScore;
                row.appendChild(totalCell);
                historyTableBody.appendChild(row);
                overallGrandTotal += totalTribeScore;
            }
        }
        
        // Atualiza o "TOTAL GERAL" no rodap√©
        document.getElementById('total_geral_acumulado_historico').innerText = overallGrandTotal;

        // Recalcula e atualiza os totais por semana no rodap√©
        for (let i = 0; i < TOTAL_WEEKS; i++) {
            let weekTotal = 0;
            for (const tribeId in tribes) {
                if (Object.prototype.hasOwnProperty.call(tribes, tribeId)) {
                    weekTotal += tribes[tribeId].weeklyScores[i] || 0;
                }
            }
            const totalCellElement = document.getElementById(`total_semana_historico_${i + 1}`);
            if(totalCellElement) {
                totalCellElement.innerText = weekTotal;
            }
        }
    }


    // --- Inicializa√ß√£o ---
    function initialize() {
        document.getElementById('login-modal').classList.add('hidden');
        document.getElementById('total-weeks-display').innerText = TOTAL_WEEKS;

        // Sempre carrega o estado para preencher os dados p√∫blicos
        loadRallyStateFromSheet();

        // Tenta fazer o login autom√°tico se houver credenciais salvas
        if (localStorage.getItem('rallyAuthenticatedUser')) {
            authenticatedUser = JSON.parse(localStorage.getItem('rallyAuthenticatedUser'));
            performLoginFromLocalStorage();
        } else {
            // Se n√£o houver credenciais, mostra o conte√∫do p√∫blico e esconde o admin
            document.getElementById('public-content').classList.remove('hidden');
            document.getElementById('admin-content').classList.add('hidden');
            document.getElementById('admin-reset-button').classList.add('hidden');
        }
    }

    async function performLoginFromLocalStorage() {
        if (!authenticatedUser) return;

        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'login',
                    username: authenticatedUser.username,
                    password: authenticatedUser.password
                }),
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    document.getElementById('public-content').classList.add('hidden');
                    document.getElementById('admin-content').classList.remove('hidden');
                    document.getElementById('admin-reset-button').classList.remove('hidden');
                    await loadRallyStateFromSheet(); // Recarrega para garantir dados atualizados no admin
                    updateWeekSelector(); // Popula o seletor de semana
                    toggleSection('daily-missions-section-admin'); // Mostra a se√ß√£o padr√£o da secretaria
                } else {
                    console.warn("Login autom√°tico falhou, credenciais salvas inv√°lidas ou Apps Script negou. Limpando localStorage.");
                    localStorage.removeItem('rallyAuthenticatedUser');
                    authenticatedUser = null;
                    document.getElementById('public-content').classList.remove('hidden');
                    document.getElementById('admin-content').classList.add('hidden');
                    document.getElementById('admin-reset-button').classList.add('hidden');
                    loadRallyStateFromSheet(); // Recarrega os dados p√∫blicos (sem login)
                }
            } else {
                console.error("Erro no servidor ao tentar login autom√°tico. Status: " + response.status);
                localStorage.removeItem('rallyAuthenticatedUser');
                authenticatedUser = null;
                document.getElementById('public-content').classList.remove('hidden');
                document.getElementById('admin-content').classList.add('hidden');
                document.getElementById('admin-reset-button').classList.add('hidden');
                loadRallyStateFromSheet(); // Recarrega os dados p√∫blicos (sem login)
            }
        } catch (error) {
            console.error('Erro ao tentar login autom√°tico (rede/JSON):', error);
            localStorage.removeItem('rallyAuthenticatedUser');
            authenticatedUser = null;
            document.getElementById('public-content').classList.remove('hidden');
            document.getElementById('admin-content').classList.add('hidden');
            document.getElementById('admin-reset-button').classList.add('hidden');
            loadRallyStateFromSheet(); // Recarrega os dados p√∫blicos (sem login)
        }
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>

</body>
</html>